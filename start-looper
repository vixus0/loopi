#!/usr/bin/env bash

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "Running as user $USER in dir $DIR"

$DIR/stop-looper 2>/dev/null

set -e
set -u
set -o pipefail

function stop {
  $DIR/stop-looper
}

trap EXIT stop

mkdir -p $DIR/log

# Settings
LOOPS=4
BINDINGS="$DIR/fcb1010-pi.slb"
MONOHORN="$DIR/monohorn/bin/monohorn"
SLOONICORN="$DIR/sloonicorn/sloo"


# Start Monohorn - needs root
echo "Starting monohorn"
sudo "$MONOHORN" > $DIR/log/monohorn.log 2>&1 &

# Start sloonicorn - give monohorn time to start
echo "Starting sloonicorn"

# Check for remote sooperlooper
if test ! -z "${SL_OSC_URL:-}"; then

  echo "Using remote SL at: $SL_OSC_URL"
  "$SLOONICORN" -s "$SL_OSC_URL" > $DIR/log/sloonicorn.log 2>/dev/null &

else

  # Start sloonicorn
  "$SLOONICORN" > $DIR/log/sloonicorn.log 2>/dev/null &

  
  # Check if our USB soundcard is connected
  for i in {1..10}; do
    card1="$(aplay -l | awk '/card [1-9]:/ {print $3; exit}')"
    test -n "$card1" && break || sleep 1
  done

  # Try and start jack
  if test -z "$card1"; then
    echo "No USB soundcard connected"
    exit 1
  else
    echo "Starting jack: $card1 device"
    $DIR/start-jackd "$card1" > $DIR/log/jack.log 2>&1 &
  fi

  # Give jackd time to start
  jack_wait -w -t 3 2>/dev/null

  if test "$(jack_wait -c)" = "running"; then
    # Start sooperlooper
    echo "Starting sooperlooper with $LOOPS loops"
    sooperlooper -m "$BINDINGS" -l "$LOOPS" > $DIR/log/sooperlooper.log 2>/dev/null &

    # Make jack connections after waiting on sooperlooper
    sleep 2

    echo "Connecting jack ports"
    jack_connect system:capture_1 sooperlooper:common_in_1
    jack_connect system:capture_2 sooperlooper:common_in_2
    jack_connect sooperlooper:common_out_1 system:playback_1
    jack_connect sooperlooper:common_out_2 system:playback_2

    # Make midi connections - Pick last real MIDI device
    #MIDI_DEV="$(aseqdump -l | awk '!/name|System|Through/ {d = $2} END {printf d}')"
    MIDI_DEV="US-2x2"

    if test ! -z "$(aconnect -o | grep "$MIDI_DEV")"; then
      # Start loopidings
      echo "Starting loopidings"
      RECORDINGS="/media/usb/djcorbyn/track_" ./loopidings.py > $DIR/log/loopidings.log 2>/dev/null &

      sleep 2

      echo "Connecting $MIDI_DEV to sooperlooper"
      aconnect "${MIDI_DEV}:0" "sooperlooper:0"

      echo "Connecting $MIDI_DEV to loopidings"
      aconnect "${MIDI_DEV}:0" "loopidings:0"
    else
      echo "$MIDI_DEV MIDI device not connected"
      exit 1
    fi

    # Set dry level
    echo "Applying SL settings"
    oscsend "${SL_OSC_URL:-osc.udp://localhost:9951}" "/set" "sf" "dry" "1.0"

    # Quantize stuff
    oscsend "${SL_OSC_URL:-osc.udp://localhost:9951}" "/set" "sf" "sync_source" "1.0"
    oscsend "${SL_OSC_URL:-osc.udp://localhost:9951}" "/set" "sf" "output_midi_clock" "1.0"
    oscsend "${SL_OSC_URL:-osc.udp://localhost:9951}" "/sl/-1/set" "sf" "quantize" "1.0"
    oscsend "${SL_OSC_URL:-osc.udp://localhost:9951}" "/sl/-1/set" "sf" "sync" "1.0"
    oscsend "${SL_OSC_URL:-osc.udp://localhost:9951}" "/sl/-1/set" "sf" "relative_sync" "1.0"
    oscsend "${SL_OSC_URL:-osc.udp://localhost:9951}" "/sl/-1/set" "sf" "autoset_latency" "1.0"

    # Select first loop
    oscsend "${SL_OSC_URL:-osc.udp://localhost:9951}" "/set" "sf" "selected_loop_num" "0.0"
  else
    echo "jack couldn't start"
    exit 1
  fi

fi

exit 0
